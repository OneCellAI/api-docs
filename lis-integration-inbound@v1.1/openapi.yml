openapi: 3.1.0
info:
  title: OneCell ← LIS Integration API
  version: 1.1.0
  description: Спецификация API интеграции со стороны PACS OneCell
  license:
    name: UNLICENSED (private use only)
    url: https://onecell.ai/api/license
  termsOfService: https://www.onecell.ai/api/terms
  contact:
    url: https://onecell.ai
    name: OneCell Platform team
    email: platform@onecell.ai
servers:
  - url: https://integration.onecell.acme.corp/some-prefix
security:
  - BasicAuth: []
paths:
  /lis/v1/case:
    post:
      summary: Выгрузка мед. случаев в PACS
      description: Создание/обновление медицинских случаев и данных пациента в PACS OneCell
      operationId: upsertCases
      responses:
        '200':
          $ref: '#/components/responses/BulkMethodResponse'
        '201':
          description: Created
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '413':
          $ref: '#/components/responses/ErrorResponse'
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/UpsertPacsCaseDto'
                example:
                  caseNumber: B00000001
                  orderNumber: '111333699'
                  caseDate: '2019-08-24T14:15:22Z'
                  patient:
                    patientId: string
                    fullname: string
                    birthDate: string
                    sex: MALE
                  service:
                    id: string
                    shortName: string
                    name: string
                  incomingIcd10:
                    id: string
                    shortName: string
                    name: string
                  macroDescription: string
                  description: string
                  doctorId:
                    userIdentifier: string
                    fullname: string
                  materialTakeoutDate: '2019-08-24T14:15:22Z'
                  materialType:
                    id: string
                    shortName: string
                    name: string
                  diagnosticProcedureType:
                    id: string
                    shortName: string
                    name: string
                  caseResearchType:
                    id: string
                    shortName: string
                    name: string
                  comment: string
                  notes:
                    - noteId: string
                      author:
                        userIdentifier: string
                        fullname: string
                      createdAt: '2019-08-24T14:15:22Z'
                      body: string
                  bioMaterials:
                    - bioMaterialId: '1011021031'
                      bioMaterial: string
                      site:
                        id: string
                        shortName: string
                        name: string
                      processNature:
                        id: string
                        shortName: string
                        name: string
                      fragmentsCount: 0
                      blocksCount: 0
                      slidesCount: 0
                  blocks:
                    - blockId: string
                      site:
                        id: string
                        shortName: string
                        name: string
                  slides:
                    - slideId: string
                      blockId: string
                      stain:
                        id: string
                        shortName: string
                        name: string
    delete:
      summary: Удаление мед. случаев из PACS
      description: Удаление медицинских случаев из PACS OneCell
      operationId: deleteCases
      responses:
        '200':
          $ref: '#/components/responses/BulkMethodResponse'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '413':
          $ref: '#/components/responses/ErrorResponse'
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/DeletePacsCaseDto'
  /lis/v1/case/{caseNumber}/medical-report:
    parameters:
      - schema:
          type: string
        name: caseNumber
        in: path
        required: true
        description: Уникальный идентификатор мед. случая
    post:
      summary: Выгрузка мед. заключений в PACS
      description: Создание/обновление медицинского заключения в PACS OneCell
      operationId: upsertCaseMedicalReport
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationStatusDto'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '413':
          $ref: '#/components/responses/ErrorResponse'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertPacsMedicalReportDto'
components:
  securitySchemes:
    BasicAuth:
      type: http
      scheme: basic
  schemas:
    PatientDto:
      title: PatientDto
      type: object
      description: Информация о пациенте в ЛИС для выгрузки в PACS OneCell
      properties:
        patientId:
          type: string
          description: Уникальный ID пациента в рамках мед. учреждения
          pattern: ^(?!\s*$).+
        fullname:
          type: string
          description: ФИО пациента
          pattern: ^(?!\s*$).+
        birthDate:
          type: string
          description: Дата рождения пациента
          format: date
        sex:
          type: string
          description: Пол пациента
          enum:
            - MALE
            - FEMALE
        globalPatientId:
          type: string
          description: Глобально уникальный ID пациента в рамках страны (напр. ЕМИАС или СНИЛС). Данный идентификатор используется для объединения пациентов из нескольких медицинских учреждений
      required:
        - patientId
        - fullname
        - birthDate
        - sex
    DictionaryRef:
      title: DictionaryRef
      type: object
      description: Ссылка на значение в справочнике
      required:
        - id
        - name
      properties:
        id:
          type: string
          description: |
            **Уникальный** идентификатор записи в справочнике. Используется для поиска записи
            при автообновлении справочников.

            **Отвественно относитесь к выбору идентификатора для этого поля.**

            Автообновление работает следующим образом:
            1. Напр. Вы опубликовали медицинский случай с Icd10 = `(id=123, shortName=C40.0, name=ABCDEF)`
            2. Затем Вы опубликовали другой медицинский случай с Icd10 = `(id=123, shortName=C41.0, name=DEADBEEF)`
            3. Для первого медицинского случая значение справочника тоже переименуется из `C40.0 ABCDEF` в `C41.0 DEADBEEF`,
               поскольку для этого случая было использовано то же самое значение `id` в выбранном элементе справочника.
          pattern: ^(?!\s*$).+
        shortName:
          type: string
          description: |-
            **NEW!**
            Короткое название записи в справочнике, отображаемое в интерфейсе (код элемента справочника). Например, "HE".

            Если поле `shortName` не заполнено или не указано в запросе - OneCell на своей стороне будет брать значение из поля `id` для отображения в интерфейсе.
          pattern: ^(?!\s*$).+
        name:
          type: string
          description: Полное название записи в справочнике, отображаемое в интерфейсе. Например, "Гематоксилин".
          pattern: ^(?!\s*$).+
    UserRef:
      title: UserRef
      type: object
      description: Ссылка на пользователя в Active Directory
      properties:
        userIdentifier:
          type: string
          description: Идентификатор пользователя в AD (sAMAccountName)
          pattern: ^(?!\s*$).+
        fullname:
          type: string
          description: Полное имя пользователя
          pattern: ^(?!\s*$).+
      required:
        - userIdentifier
        - fullname
    NoteDto:
      title: NoteDto
      type: object
      description: |-
        Информация о заметке в мед. случае на стороне ЛИС для выгрузки в PACS OneCell
        Обратите внимание, что необходимо обязательно указать автора заметки через поле 
        `author`, либо через поле `authorExternalName`
      properties:
        noteId:
          type: string
          description: |-
            Уникальный идентификатор заметки в рамках мед. случая 
            TODO: есть ли он на стороне LIS?
          pattern: ^(?!\s*$).+
        author:
          $ref: '#/components/schemas/UserRef'
        authorExternalName:
          type: string
          description: Имя автор заметки (только если нет аккаунта в Active Directory)
          pattern: ^(?!\s*$).+
        createdAt:
          type: string
          format: date-time
          description: |-
            Дата и время создания заметки
            TODO: могут ли они менять заметки? если да, то надо updatedAt
        body:
          type: string
          description: Содержимое заметки
          pattern: ^(?!\s*$).+
      required:
        - noteId
        - createdAt
        - body
    BioMaterialInfoDto:
      title: BioMaterialInfoDto
      type: object
      description: Биоматериал
      properties:
        bioMaterialId:
          type: string
          description: Уникальный идентификатор биоматериала в рамках случая. Например, ID пробы (контейнера)
          pattern: ^(?!\s*$).+
        bioMaterial:
          type: string
          description: Биоматериал
          pattern: ^(?!\s*$).+
        site:
          $ref: '#/components/schemas/DictionaryRef'
        processNature:
          $ref: '#/components/schemas/DictionaryRef'
        fragmentsCount:
          type: integer
          format: int64
          description: Количество фрагментов
          minimum: 0
        blocksCount:
          type: integer
          format: int64
          description: Количество блоков
          minimum: 0
        slidesCount:
          type: integer
          format: int64
          description: Количество слайдов
          minimum: 0
      required:
        - bioMaterialId
    BlockInfoDto:
      title: BlockInfoDto
      type: object
      description: Блок
      properties:
        blockId:
          type: string
          description: Уникальный идентификатор блока в рамках случая. Например, номер/штрих кодблока
          pattern: ^(?!\s*$).+
        site:
          $ref: '#/components/schemas/DictionaryRef'
      required:
        - blockId
    SlideInfoDto:
      title: SlideInfoDto
      type: object
      description: Стекло
      properties:
        slideId:
          type: string
          description: Уникальный идентификатор стекла в рамках случая. Например, номер/штрихкод стекла
          pattern: ^(?!\s*$).+
        blockId:
          type: string
          description: Уникальный идентификатор блока в рамках случая. Например, номер/штрих кодблока
          pattern: ^(?!\s*$).+
        stain:
          $ref: '#/components/schemas/DictionaryRef'
      required:
        - slideId
    UpsertPacsCaseDto:
      title: UpsertPacsCaseDto
      type: object
      description: Создание/обновление медицинских случаев и данных пациента в PACS OneCell
      properties:
        caseNumber:
          type: string
          description: Уникальное название (ID) мед. случая в ЛИС
          pattern: ^(?!\s*$).+
        caseDate:
          type: string
          description: Дата заказа / дата создания медицинского случая
          format: date-time
        patient:
          $ref: '#/components/schemas/PatientDto'
        services:
          type: array
          items:
            $ref: '#/components/schemas/DictionaryRef'
        incomingIcd10:
          $ref: '#/components/schemas/DictionaryRef'
        orderNumber:
          description: Уникальный номер заказа
          type: string
        macroDescription:
          type: string
          description: Макроописание
          pattern: ^(?!\s*$).+
        description:
          type: string
          description: Клинические сведения и дополнительная информация
          pattern: ^(?!\s*$).+
        doctorId:
          $ref: '#/components/schemas/UserRef'
        materialTakeoutDate:
          type: string
          format: date-time
          description: Дата забора материала
        materialType:
          $ref: '#/components/schemas/DictionaryRef'
        diagnosticProcedureType:
          $ref: '#/components/schemas/DictionaryRef'
        caseResearchType:
          $ref: '#/components/schemas/DictionaryRef'
        comment:
          type: string
          description: Комментарий к пробе
          pattern: ^(?!\s*$).+
        notes:
          type: array
          items:
            $ref: '#/components/schemas/NoteDto'
        bioMaterials:
          type: array
          items:
            $ref: '#/components/schemas/BioMaterialInfoDto'
        blocks:
          type: array
          items:
            $ref: '#/components/schemas/BlockInfoDto'
        slides:
          type: array
          items:
            $ref: '#/components/schemas/SlideInfoDto'
        department:
          $ref: '#/components/schemas/DictionaryRef'
        task:
          type: string
          description: Задача. Если патологоанатомическое исследование - задача прижизненного патологоанатомического исследования
      required:
        - caseNumber
        - caseDate
        - patient
        - services
        - notes
        - bioMaterials
        - blocks
        - slides
    FieldError:
      title: FieldError
      type: object
      properties:
        code:
          type: string
          description: Field error code
          example: INVALID_SIZE
          pattern: ^(?!\s*$).+
        property:
          type: string
          example: name
          description: Property name
          pattern: ^(?!\s*$).+
        message:
          type: string
          description: Field error message
          example: size must be between 10 and 2147483647
          pattern: ^(?!\s*$).+
        rejectedValue:
          type: string
          example: abc
          description: Original field value
          pattern: ^(?!\s*$).+
        path:
          type: string
          example: name
          description: Property path
          pattern: ^(?!\s*$).+
      required:
        - code
        - property
        - message
        - path
    ErrorResponseDto:
      title: ErrorResponseDto
      type: object
      properties:
        code:
          type: string
          description: Error code
          example: VALIDATION_FAILED
          pattern: ^(?!\s*$).+
        message:
          type: string
          description: Error message
          example: 'Validation failed for object=''exampleRequestBody''. Error count: 1'
          pattern: ^(?!\s*$).+
        fieldErrors:
          type: array
          description: Field errors (on validation error)
          items:
            $ref: '#/components/schemas/FieldError'
      required:
        - code
        - message
    OperationStatusDto:
      title: OperationStatusDto
      type: object
      properties:
        id:
          type: string
          description: Идентификатор сущности (ID медицинского случая/пациента и т.п.)
          pattern: ^(?!\s*$).+
        success:
          type: boolean
          description: Операция выполнена успешно?
        error:
          $ref: '#/components/schemas/ErrorResponseDto'
      required:
        - id
        - success
    DeletePacsCaseDto:
      title: DeletePacsCaseDto
      type: object
      description: Запрос удаления/восстановления медицинского случая в PACS OneCell
      properties:
        caseNumber:
          type: string
          description: Уникальное название (ID) мед. случая в ЛИС
          pattern: ^(?!\s*$).+
        method:
          type: string
          description: Способ удаления (мягкое или жёсткое), либо запрос на восстановления из корзины
          enum:
            - HARD_DELETION
            - SOFT_DELETION
            - RESTORE
      required:
        - caseNumber
        - method
    Icd10WithAdditionalCodes:
      title: Icd10WithAdditionalCodes
      type: object
      description: МКБ-10 + топографический, морфологический коды, характер процесса и тип исследования
      properties:
        icd10:
          $ref: '#/components/schemas/DictionaryRef'
        topographicalIcdO:
          $ref: '#/components/schemas/DictionaryRef'
        morphologicalIcdO:
          $ref: '#/components/schemas/DictionaryRef'
        processNature:
          $ref: '#/components/schemas/DictionaryRef'
        tnmClassification:
          type: string
      required:
        - icd10
    UpsertPacsMedicalReportDto:
      title: UpsertPacsMedicalReportDto
      type: object
      description: Создание/обновление медицинских заключений в PACS OneCell
      properties:
        macroDescription:
          type: string
          description: Макроописание (будет обновлено в мед. случае)
          pattern: ^(?!\s*$).+
        microDescription:
          type: string
          description: Микроописание
          pattern: ^(?!\s*$).+
        report:
          type: string
          description: Заключение
          pattern: ^(?!\s*$).+
        comment:
          type: string
          description: Доп. замечания и рекомендации
          pattern: ^(?!\s*$).+
        complexity:
          type: integer
          description: Категория сложности
          minimum: 1
          maximum: 5
        icd10:
          $ref: '#/components/schemas/DictionaryRef'
        icd10DetailedList:
          type: array
          description: Поле обязательно, если `icd10` не указано
          items:
            $ref: '#/components/schemas/Icd10WithAdditionalCodes'
        morphologyCode:
          $ref: '#/components/schemas/DictionaryRef'
        doctorId:
          $ref: '#/components/schemas/UserRef'
        consultantId:
          $ref: '#/components/schemas/UserRef'
        ihcResult:
          type: string
          description: Результат ИГХ
          pattern: ^(?!\s*$).+
        additionalResearchResult:
          type: string
          description: Результат доп. исследований
          pattern: ^(?!\s*$).+
        signed:
          type: boolean
          description: Факт подписания заключения (валидации). Для отмены валидации необходимо отправить весь объект заключения с установленным значением `signed=false`
        signedAt:
          type: string
          format: date-time
          description: Время подписания заключения (валидации). Может использоваться для расчёта оставшегося времени, в течение которого доступна отмена валидации заключения.
        locked:
          type: boolean
          description: Факт блокирови редактирования заключения.  Если `true`, редактирование заключения в интерфейсе PACS OneCell будет заблокировано. Для отмены блокировки необходимо выгрузить заключение из LIS в PACS со значением `locked=false`
      required:
        - doctorId
        - signed
  responses:
    BulkMethodResponse:
      description: Результат выполнения групповой операции
      content:
        application/json:
          schema:
            type: array
            items:
              $ref: '#/components/schemas/OperationStatusDto'
          examples:
            example-1:
              value:
                - id: B0000000001
                  success: true
                - id: B0000000002
                  success: false
                  error:
                    code: VALIDATION_FAILED
                    message: 'Validation failed for object=''body''. Error count: 1'
                    fieldErrors:
                      - code: INVALID_SIZE
                        property: name
                        message: size must be between 2 and 2147483647
                        rejectedValue: a
                        path: person.name
    ErrorResponse:
      description: Error response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponseDto'
            description: ''
            x-examples:
              example-1:
                timestamp: '2021-11-12T15:47:13.130+00:00'
                status: 404
                error: Not Found
                exception: ai.onecell.service.filestorage.exceptions.BlobNotFoundException
                message: Blob is not found
                path: /v1/some-url
