openapi: 3.1.0
info:
  title: OneCell ← LIS Integration API
  version: 1.10.0
  license:
    name: Commercial
    url: https://onecell.ai/#api-license
  description: |-
    Данный домумент описывает конечные точки (endpoints), 
    которые реализует **ПАКС OneCell** со своей стороны для интеграции с **ЛИС**.

    ЛИС будет делать запросы на данные конечные точки для передачи информации из **ЛИС** в **ПАКС**.
servers:
  - url: https://integration.onecell.acme.corp
security:
  - BasicAuth: []
paths:
  /lis/v1/case:
    post:
      summary: Выгрузка мед. случаев в PACS
      description: Создание/обновление медицинских случаев и данных пациента в PACS OneCell
      operationId: upsertCases
      responses:
        '200':
          $ref: '#/components/responses/BulkMethodResponse'
        '201':
          description: Created
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '413':
          $ref: '#/components/responses/ErrorResponse'
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/UpsertPacsCaseDto'
    delete:
      summary: Удаление мед. случаев из PACS
      description: Удаление медицинских случаев из PACS OneCell
      operationId: deleteCases
      responses:
        '200':
          $ref: '#/components/responses/BulkMethodResponse'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '413':
          $ref: '#/components/responses/ErrorResponse'
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/DeletePacsCaseDto'
  /lis/v1/case/{caseNumber}/medical-report:
    parameters:
      - schema:
          type: string
        name: caseNumber
        in: path
        required: true
        description: Уникальный идентификатор мед. случая
    post:
      summary: Выгрузка мед. заключений в PACS
      description: Создание/обновление медицинского заключения в PACS OneCell
      operationId: upsertCaseMedicalReport
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationStatusDto'
        '400':
          $ref: '#/components/responses/ErrorResponse'
        '401':
          $ref: '#/components/responses/ErrorResponse'
        '403':
          $ref: '#/components/responses/ErrorResponse'
        '413':
          $ref: '#/components/responses/ErrorResponse'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertPacsMedicalReportDto'
components:
  securitySchemes:
    BasicAuth:
      type: http
      scheme: basic
  schemas:
    PatientDto:
      title: PatientDto
      type: object
      description: Информация о пациенте в ЛИС для выгрузки в PACS OneCell
      properties:
        patientId:
          type: string
          description: Уникальный ID пациента в рамках мед. учреждения
          pattern: ^(?!\s*$).+
          example: 1323-000111222
        fullname:
          type: string
          description: ФИО пациента
          pattern: ^(?!\s*$).+
          example: Иванов Иван Иванович
        birthDate:
          type: string
          description: Дата рождения пациента
          format: date
          example: '1985-01-01'
        sex:
          type: string
          description: Пол пациента
          enum:
            - MALE
            - FEMALE
          example: MALE
        globalPatientId:
          type: string
          description: Глобально уникальный ID пациента в рамках страны (напр. ЕМИАС или СНИЛС). Данный идентификатор используется для объединения пациентов из нескольких медицинских учреждений
          example: '1900121345'
      required:
        - patientId
        - fullname
        - birthDate
        - sex
    DictionaryRef:
      title: DictionaryRef
      type: object
      description: Ссылка на значение в справочнике
      required:
        - id
        - name
      properties:
        id:
          type: string
          description: |
            **Уникальный** идентификатор записи в справочнике. Используется для поиска записи при автообновлении справочников.
            **Отвественно относитесь к выбору идентификатора для этого поля.**
            Автообновление работает следующим образом:
            1. Напр. Вы опубликовали медицинский случай с Icd10 = `(id=123, shortName=C40.0, name=ABCDEF)`
            2. Затем Вы опубликовали другой медицинский случай с Icd10 = `(id=123, shortName=C41.0, name=DEADBEEF)`
            3. Для первого медицинского случая значение справочника тоже переименуется из `C40.0 ABCDEF` в `C41.0 DEADBEEF`, поскольку для этого случая было использовано то же самое значение `id`  в выбранном элементе справочника.
          pattern: ^(?!\s*$).+
          example: '123'
        shortName:
          type: string
          description: |-
            **NEW!**
            Короткое название записи в справочнике, отображаемое в интерфейсе (код элемента справочника). Например, "HE".

            Если поле `shortName` не заполнено или не указано в запросе - OneCell на своей стороне будет брать значение из поля `id` для отображения в интерфейсе.
          pattern: ^(?!\s*$).+
          example: КрткНзв
        name:
          type: string
          description: Полное название записи в справочнике, отображаемое в интерфейсе. Например, "Гематоксилин".
          pattern: ^(?!\s*$).+
          example: Полное название элемента справочника
    UserRef:
      title: UserRef
      type: object
      description: Ссылка на пользователя в Active Directory
      properties:
        userIdentifier:
          type: string
          description: Идентификатор пользователя в AD (sAMAccountName)
          pattern: ^(?!\s*$).+
        fullname:
          type: string
          description: Полное имя пользователя
          pattern: ^(?!\s*$).+
      required:
        - userIdentifier
        - fullname
    NoteDto:
      title: NoteDto
      type: object
      description: |-
        Информация о заметке в мед. случае на стороне ЛИС для выгрузки в PACS OneCell
        Обратите внимание, что необходимо обязательно указать автора заметки через поле 
        `author`, либо через поле `authorExternalName`
      properties:
        noteId:
          type: string
          description: Уникальный идентификатор заметки в рамках мед. случая
          pattern: ^(?!\s*$).+
          example: NOTE00001
        author:
          $ref: '#/components/schemas/UserRef'
          description: Автор заметки (если есть аккаунт в Active Directory)
        authorExternalName:
          type: string
          description: Имя автора заметки (только если нет аккаунта в Active Directory)
          pattern: ^(?!\s*$).+
          example: Василий Петрович
        createdAt:
          type: string
          format: date-time
          description: Дата и время создания заметки
          example: '2024-09-17T13:38:27+00:00'
        body:
          type: string
          description: Содержимое заметки
          pattern: ^(?!\s*$).+
          example: Случай был перемещён из архива Василием Петровичем
      required:
        - noteId
        - createdAt
        - body
    BioMaterialInfoDto:
      title: BioMaterialInfoDto
      type: object
      description: Биоматериал
      properties:
        bioMaterialId:
          type: string
          description: Уникальный идентификатор биоматериала в рамках случая. Например, ID пробы (контейнера)
          pattern: ^(?!\s*$).+
          example: 5130-I22006394-0001
        bioMaterial:
          type: string
          description: Биоматериал
          pattern: ^(?!\s*$).+
          example: Костная ткань
        site:
          $ref: '#/components/schemas/DictionaryRef'
        processNature:
          $ref: '#/components/schemas/DictionaryRef'
        fragmentsCount:
          type: integer
          format: int64
          description: Количество фрагментов
          minimum: 0
          example: 3
        blocksCount:
          type: integer
          format: int64
          description: Количество блоков
          minimum: 0
          example: 4
        slidesCount:
          type: integer
          format: int64
          description: Количество слайдов
          minimum: 0
          example: 5
      required:
        - bioMaterialId
    BlockInfoDto:
      title: BlockInfoDto
      type: object
      description: Блок
      properties:
        blockId:
          type: string
          description: Уникальный идентификатор блока в рамках случая. Например, номер/штрихкод блока
          pattern: ^(?!\s*$).+
          example: 1-2
        site:
          $ref: '#/components/schemas/DictionaryRef'
      required:
        - blockId
    StainDictionaryRef:
      title: StainDictionaryRef
      type: object
      description: Ссылка на значение в справочнике "Окраски"
      required:
        - id
        - name
      properties:
        id:
          type: string
          description: |
            **Уникальный** идентификатор записи в справочнике. Используется для поиска записи при автообновлении справочников.
            **Отвественно относитесь к выбору идентификатора для этого поля.**
            Автообновление работает следующим образом:
            1. Напр. Вы опубликовали медицинский случай с Stain = `(id=123, shortName=H&E, name=Гематоксилин)`
            2. Затем Вы опубликовали другой медицинский случай с Stain = `(id=123, shortName=Ki67, name=Ki-67)`
            3. Для первого медицинского случая значение справочника тоже переименуется из `H&E Гематоксилин` в `Ki67 Ki-67`, поскольку для этого случая было использовано то же самое значение `id`  в выбранном элементе справочника.
          pattern: ^(?!\s*$).+
          example: '00001'
        shortName:
          type: string
          description: |-
            **NEW!**
            Короткое название записи в справочнике, отображаемое в интерфейсе (код элемента справочника). Например, "HE".

            Если поле `shortName` не заполнено или не указано в запросе - OneCell на своей стороне будет брать значение из поля `id` для отображения в интерфейсе.
          pattern: ^(?!\s*$).+
          example: H&E
        name:
          type: string
          description: Полное название записи в справочнике, отображаемое в интерфейсе. Например, "Гематоксилин Эозин".
          pattern: ^(?!\s*$).+
          example: Гематоксилин Эозин
        stainType:
          type: string
          description: |-
            🆕Добавлено в версии API 1.10

            Тип окраски. HC - гистохимическая, IHC - иммуногистохимическая.
          enum:
            - HC
            - IHC
          example: HC
        availableForOrder:
          type: boolean
          description: |-
            🆕Добавлено в версии API 1.10

            Доступна ли окраска для запросов на дозаказ.
          example: false
    SlideInfoDto:
      title: SlideInfoDto
      type: object
      description: Стекло
      properties:
        slideId:
          type: string
          description: Уникальный идентификатор стекла в рамках случая. Например, номер/штрихкод стекла
          pattern: ^(?!\s*$).+
          example: 5130-I22006394-1-2-3
        blockId:
          type: string
          description: Уникальный идентификатор блока в рамках случая. Например, номер/штрихкод блока
          pattern: ^(?!\s*$).+
          example: 1-2
        stain:
          $ref: '#/components/schemas/StainDictionaryRef'
        researchRequestSlideId:
          type: string
          description: |-
            🆕Добавлено в версии API 1.10

            ID конкретного стекла из ЗнД. Необходимо, чтобы OneCell понимал, какое стекло из ЗнД готово, а какое нет.
            Изначально ЛИС должен получать этот ID от OneCell во время получения Дозаказа, а затем передавать значение (из поля `slides.*.researchRequestSlideId`) обратно в OneCell.

            **Не путайте** с полем `researchRequestId`. Сюда нужно указывать именно идентификатор **"Стекла в ЗнД"** (`researchRequestSlideId`), а не самой **"ЗнД"**, это разные идентификаторы.
          example: rrs-bb43d2bc-45b1-4736-a470-cee8e788af61
      required:
        - slideId
    UpsertPacsCaseDto:
      title: UpsertPacsCaseDto
      type: object
      description: Создание/обновление медицинских случаев и данных пациента в PACS OneCell
      properties:
        caseNumber:
          type: string
          description: Уникальное название (ID) мед. случая в ЛИС
          pattern: ^(?!\s*$).+
          example: 5130-I22006394
        caseDate:
          type: string
          description: Дата заказа / дата создания медицинского случая
          format: date-time
          example: '2024-09-17T13:38:27+00:00'
        patient:
          $ref: '#/components/schemas/PatientDto'
        services:
          type: array
          items:
            $ref: '#/components/schemas/DictionaryRef'
        incomingIcd10:
          $ref: '#/components/schemas/DictionaryRef'
        orderNumber:
          description: Уникальный номер заказа
          type: string
          example: ORD-000000001
        macroDescription:
          type: string
          description: Макроописание
          pattern: ^(?!\s*$).+
          example: Макроописание макроописание макроописание
        description:
          type: string
          description: Клинические сведения и дополнительная информация
          pattern: ^(?!\s*$).+
          example: Клиническое описание...
        doctorId:
          $ref: '#/components/schemas/UserRef'
        materialTakeoutDate:
          type: string
          format: date-time
          description: Дата забора материала
          example: '2024-09-17T13:38:27+00:00'
        materialType:
          $ref: '#/components/schemas/DictionaryRef'
        diagnosticProcedureType:
          $ref: '#/components/schemas/DictionaryRef'
        caseResearchType:
          $ref: '#/components/schemas/DictionaryRef'
        comment:
          type: string
          description: Комментарий к пробе
          pattern: ^(?!\s*$).+
          example: Комментарий к пробе...
        notes:
          type: array
          items:
            $ref: '#/components/schemas/NoteDto'
        bioMaterials:
          type: array
          items:
            $ref: '#/components/schemas/BioMaterialInfoDto'
        blocks:
          type: array
          items:
            $ref: '#/components/schemas/BlockInfoDto'
        slides:
          type: array
          items:
            $ref: '#/components/schemas/SlideInfoDto'
        department:
          $ref: '#/components/schemas/DictionaryRef'
        task:
          type: string
          description: Задача. Если патологоанатомическое исследование - задача прижизненного патологоанатомического исследования
          example: Постановка диагноза и составление рекомендаций
        researchRequestId:
          type: string
          description: |-
            🆕Добавлено в версии API 1.10

            На основании какого Дозаказа был создан данный Случай.

            Изначально ЛИС должен получать этот ID от OneCell во время получения ЗнД (поле `researchRequestId`), а затем передавать значение обратно в OneCell в этом поле.
          example: rr-96eafb9e-0b79-493e-b336-3142827db07e
      required:
        - caseNumber
        - caseDate
        - patient
        - services
        - notes
        - bioMaterials
        - blocks
        - slides
    FieldError:
      title: FieldError
      type: object
      properties:
        code:
          type: string
          description: Код ошибки на поле
          example: INVALID_SIZE
          pattern: ^(?!\s*$).+
        property:
          type: string
          example: name
          description: Название поля
          pattern: ^(?!\s*$).+
        message:
          type: string
          description: Человеко-читаемая ошибка на поле
          example: Поле должно содержать как минимум 3 символа
          pattern: ^(?!\s*$).+
        rejectedValue:
          type: string
          example: Ва
          description: Оригинальное значение поля
          pattern: ^(?!\s*$).+
        path:
          type: string
          example: patient.fullname
          description: Полный путь к полю
          pattern: ^(?!\s*$).+
      required:
        - code
        - property
        - message
        - path
    ErrorResponseDto:
      title: ErrorResponseDto
      type: object
      properties:
        code:
          type: string
          description: Error code
          example: VALIDATION_FAILED
          pattern: ^(?!\s*$).+
        message:
          type: string
          description: Error message
          example: Поля объекта заполнены некорректно
          pattern: ^(?!\s*$).+
        fieldErrors:
          type: array
          description: Field errors (on validation error)
          items:
            $ref: '#/components/schemas/FieldError'
      required:
        - code
        - message
    OperationStatusDto:
      title: OperationStatusDto
      type: object
      properties:
        id:
          type: string
          description: Идентификатор сущности (ID медицинского случая/пациента и т.п.)
          pattern: ^(?!\s*$).+
          example: '123123123'
        success:
          type: boolean
          description: Операция выполнена успешно?
          example: false
        retryable:
          type: boolean
          description: |-
            🆕Добавлено в версии API 1.10

            Должна ли система, отправившая запрос, повторить его выгрузку ещё раз в случае ошибки.

            Если `success = true`, то значение всегда `retryable = false`.
            Если `success = false`, то:
            1. `retryable = true`, если принимающая система ДОЛЖНА попробовать выгрузить данный объект повторно через время (например, если на принимающей стороне произошла ошибка обращения к внешнему серверу или к БД)
            2. `retryable = false`, если принимающая система НЕ ДОЛЖНА выполнять повторные попытки выгрузки данной сущности (напр. поля в сущности указаны некорректно и повторные попытки выгрузки такого объекта никогда не приведут к успешному результату)
          example: false
        error:
          $ref: '#/components/schemas/ErrorResponseDto'
      required:
        - id
        - success
    DeletePacsCaseDto:
      title: DeletePacsCaseDto
      type: object
      description: Запрос удаления/восстановления медицинского случая в PACS OneCell
      properties:
        caseNumber:
          type: string
          description: Уникальное название (ID) мед. случая в ЛИС
          pattern: ^(?!\s*$).+
          example: 5130-I22006394
        method:
          type: string
          description: Способ удаления (мягкое или жёсткое), либо запрос на восстановления из корзины
          enum:
            - HARD_DELETION
            - SOFT_DELETION
            - RESTORE
          example: HARD_DELETION
      required:
        - caseNumber
        - method
    Icd10WithAdditionalCodes:
      title: Icd10WithAdditionalCodes
      type: object
      description: МКБ-10 + топографический, морфологический коды, характер процесса и тип исследования
      properties:
        icd10:
          $ref: '#/components/schemas/DictionaryRef'
          description: Код МКБ-10
        topographicalIcdO:
          $ref: '#/components/schemas/DictionaryRef'
          description: Топографический МКБ-О код
        morphologicalIcdO:
          $ref: '#/components/schemas/DictionaryRef'
          description: Морфологический МКБ-О код
        processNature:
          $ref: '#/components/schemas/DictionaryRef'
          description: Тип процесса
        tnmClassification:
          type: string
          description: Классификация TNM
      required:
        - icd10
    UpsertPacsMedicalReportDto:
      title: UpsertPacsMedicalReportDto
      type: object
      description: Создание/обновление медицинских заключений в PACS OneCell
      properties:
        macroDescription:
          type: string
          description: Макроописание (будет обновлено в мед. случае)
          pattern: ^(?!\s*$).+
        microDescription:
          type: string
          description: Микроописание
          pattern: ^(?!\s*$).+
        report:
          type: string
          description: Заключение
          pattern: ^(?!\s*$).+
        comment:
          type: string
          description: Доп. замечания и рекомендации
          pattern: ^(?!\s*$).+
        complexity:
          type: integer
          description: Категория сложности
          minimum: 1
          maximum: 5
        icd10:
          $ref: '#/components/schemas/DictionaryRef'
        icd10DetailedList:
          type: array
          description: Поле обязательно, если `icd10` не указано
          items:
            $ref: '#/components/schemas/Icd10WithAdditionalCodes'
        morphologyCode:
          $ref: '#/components/schemas/DictionaryRef'
        doctorId:
          $ref: '#/components/schemas/UserRef'
        consultantId:
          $ref: '#/components/schemas/UserRef'
        ihcResult:
          type: string
          description: Результат ИГХ
          pattern: ^(?!\s*$).+
        additionalResearchResult:
          type: string
          description: Результат доп. исследований
          pattern: ^(?!\s*$).+
        signed:
          type: boolean
          description: Факт подписания заключения (валидации). Для отмены валидации необходимо отправить весь объект заключения с установленным значением `signed=false`
        signedAt:
          type: string
          format: date-time
          description: Время подписания заключения (валидации). Может использоваться для расчёта оставшегося времени, в течение которого доступна отмена валидации заключения.
        locked:
          type: boolean
          description: Факт блокирови редактирования заключения.  Если `true`, редактирование заключения в интерфейсе PACS OneCell будет заблокировано. Для отмены блокировки необходимо выгрузить заключение из LIS в PACS со значением `locked=false`
      required:
        - doctorId
        - signed
  responses:
    BulkMethodResponse:
      description: Результат выполнения групповой операции
      content:
        application/json:
          schema:
            type: array
            items:
              $ref: '#/components/schemas/OperationStatusDto'
          examples:
            example-1:
              value:
                - id: B0000001
                  success: true
                - id: B0000002
                  success: false
                  error:
                    code: VALIDATION_FAILED
                    message: Некоторые поля заполнены некорректно
                    fieldErrors:
                      - code: INVALID_SIZE
                        property: name
                        message: Поле name должно содержать хотя-бы 2 буквы
                        rejectedValue: a
                        path: person.name
    ErrorResponse:
      description: Error response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponseDto'
            description: ''
            x-examples:
              example-1:
                timestamp: '2021-11-12T15:47:13.130+00:00'
                status: 404
                error: Not Found
                exception: ai.onecell.service.filestorage.exceptions.BlobNotFoundException
                message: Blob is not found
                path: /v1/some-url
